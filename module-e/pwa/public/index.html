<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=yes, initial-scale=1.0, maximum-scale=3.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>PWA</title>

    <!-- Application manifest -->
    <link rel="manifest" href="manifest.json">

    <script src="./RestaurantCard.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
<div class="text-center text-5xl font-bold p-4 mb-12">
    DineEase
</div>
<div id="restaurants" class="p-4 mx-auto max-w-6xl flex flex-wrap gap-8">

</div>
<dialog id="dialog" class="w-full max-w-md rounded-lg">
    <div class="p-4 flex flex-col gap-4">
        <div id="dialog-content" class="flex flex-col gap-2">

        </div>
        <button id="close"
                class="p-2 text-center bg-blue-100 hover:bg-blue-200 active:bg-blue-300 font-bold text-blue-500 rounded-lg">
            Close
        </button>
    </div>
</dialog>
<div id="offline" class="bg-red-100 font-bold text-red-600 rounded-md top-10 left-1/2 -translate-x-1/2 shadow-2xl p-4 fixed z-50 hidden">
    You are currently offline
</div>
<script>
    // Find containers and elements
    const restaurantsContainer = document.getElementById('restaurants');
    const dialog = document.getElementById('dialog');
    const dialogContent = document.getElementById('dialog-content');
    const closeButton = document.getElementById('close');
    const offlineNotification = document.getElementById('offline');

    /**
     * Display the menu for a given restaurant
     * @param id
     * @returns {Promise<void>}
     */
    async function displayMenu(id) {
        try {
            const result = await fetch(`/menus/${id}`);
            const data = await result.json();

            dialog.showModal();
            dialogContent.innerHTML = data.map(item => `<div class="p-4 rounded-lg bg-gray-100 flex items-center justify-between"><span>${item.dish_name}</span> <span class="text-blue-600 font-bold">${item.price} EUR</span></div>`).join('')
        } catch (e) {
            offlineNotification.classList.remove('hidden');
            setTimeout(() => offlineNotification.classList.add('hidden'), 3000);
        }
    }

    /**
     * Preload the menus of given restaurants
     * @param ids
     * @returns {Promise<Awaited<unknown>[]>}
     */
    async function loadMenus(ids){
        return Promise.all(ids.map(id => fetch(`/menus/${id}`)))
    }

    closeButton.addEventListener('click', () => dialog.close())

    /**
     * Load all restaurants and display them
     * @returns {Promise<void>}
     */
    async function loadRestaurants() {
        const result = await fetch('/restaurants');
        const data = await result.json();

        restaurantsContainer.innerHTML = data.map((r) => `<div class="basis-1/4 flex-1"><restaurant-card location="${r.location}" cuisine="${r.cuisine}" title="${r.name}" id="${r.restaurant_id}" imageSrc="https://toohotel.com/wp-content/uploads/2022/09/TOO_restaurant_Panoramique_vue_Paris_Seine_Tour_Eiffel_2.jpg">${r.description}</restaurant-card></div>`).join('')

        document.querySelectorAll('restaurant-card').forEach(elem => elem.addEventListener('select', (e) => {
            const id = e.detail.id;

            displayMenu(id);
        }))

        // Preload the menu of the first 3 restaurants
        await loadMenus(data.slice(0, 3).map(r => r.restaurant_id));
    }

    /**
     * Setup the service worker and load initial data
     */
    (async function () {
        // Register the service worker
        const registration = await navigator.serviceWorker.register("sw.js", {
            scope: "/",
        });

        // Load restaurants
        await loadRestaurants()

        // Request notification permission
        const permission = await Notification.requestPermission();
        if (permission !== 'granted') {
            console.error("Notification permission denies")
        }
    })()
</script>
</body>
</html>