<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DineEase PWA</title>

    <!-- PWA STUFF -->
    <link rel="apple-touch-icon" href="./assets/logo192.png" />
    <link rel="manifest" href="./assets/manifest.json" />

    <!-- BASIC STYLES FOR THE PAGE -->
    <style>
      body {
        font-family: Arial, Helvetica, sans-serif;
      }
      #restaurant-list {
        width: 600px;
        margin: 1rem auto;
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
      }
    </style>
    <script src="./RestaurantCard.js"></script>
  </head>
  <body>
    <div id="restaurant-list"></div>
    <dialog id="restaurant-detail"></dialog>

    <script>
      // register the service worker
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker.register("./sw.js");
      }

      // variables
      const restaurantList = document.getElementById("restaurant-list");
      const dialog = document.getElementById("restaurant-detail");
      let cards = [];
      let offers = [];

      // ask for permission on window load
      Notification.requestPermission();

      // fetch the restaurants on page load
      (async () => {
        await pollOffers();
        const res = await fetch("http://localhost/restaurants");
        restaurantList.innerHTML = (await res.json())
          .slice(0, 6)
          .map(
            (restaurant) => `
              <restaurant-card
                id="${restaurant.restaurant_id}"
                layout="vertical"
                title="${restaurant.name}"
                imageSrc="./assets/restaurant.jpg"
              >
                ${restaurant.description}
              </restaurant-card>
            `
          )
          .join("");

        // restaurant details when a user click on the continue button
        cards = document.querySelectorAll("restaurant-card");
        cards.forEach((card) =>
          card.addEventListener("select", showRestaurantDetails)
        );
      })();

      // function that shows the restaurant details in a modal
      async function showRestaurantDetails(e) {
        const { id } = e.detail;

        try {
          // display the menus
          dialog.innerHTML = "<b>Menus<b>";

          const res = await fetch(`http://localhost/menus/${id}`);
          dialog.innerHTML += (await res.json())
            .map((i) => `<div>${i.dish_name} - ${i.price} EUR</div>`)
            .join("");
        } catch {
          // display the error
          dialog.innerHTML = "You are trying to access non-cached values! ðŸ¤¬";
        } finally {
          // display the offers
          dialog.innerHTML += "<hr><b>Offers<b>";
          dialog.innerHTML +=
            offers
              .filter((x) => x.restaurant_id == id)
              .map((i) => `<div>${i.offer}</div>`)
              .join("") || "<div>There are no offers yet. ðŸ˜«<div>";

          // display the close button
          dialog.innerHTML +=
            '<hr><button onclick="dialog.close()">Close</button>';
          dialog.showModal();
        }
      }

      // a function that polls the offers
      async function pollOffers() {
        let success = true;
        try {
          const res = await fetch("http://localhost/offers");
          const resOffers = await res.json();

          offers = structuredClone(resOffers);
        } catch {
          success = false;
        }
      }

      // poll the offers every 30 seconds
      setInterval(async () => {
        const couldPoll = await pollOffers();
        if (!couldPoll) return;

        const latestOffer = offers.at(-1);

        // send the notification
        new Notification("A new offer available!", {
          body: latestOffer.offer,
        });
      }, 1000 * 30);
    </script>
  </body>
</html>
